import { Injectable, Optional } from '@nestjs/common'
import { Cron } from '@nestjs/schedule';
import axios from 'axios';
import { wrapper } from 'axios-cookiejar-support';
import { Command, Ctx, InjectBot, Start, Update } from 'nestjs-telegraf'
import { Markup, Telegraf } from 'telegraf'
import { CookieJar } from 'tough-cookie';
import { Context } from './interface/context.interface'

@Update()
@Injectable()
export class TasksService {

    jar = new CookieJar();
    webClient;
    csrf_token;

    constructor(
        @Optional() @InjectBot() private readonly bot: Telegraf<Context>
    ){
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±–æ—Ç–∞
        console.log('Starting Taksk Service contructor')

        //–°–æ–æ–±—â–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ —Ç–æ–º —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
        this.bot.telegram.sendMessage(process.env.ADMIN_TG_CHATID, '‚úÖ –ë–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è');

        this.jar = new CookieJar();
        this.webClient = wrapper(axios.create({ jar: this.jar }))

        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã —Å —Å–∏—Å—Ç–µ–º–∞–º–∏
        this.getCSRFToken();

        console.log('Taksk Service constructor is started')
    }

    @Cron('0 45 7 * * 1-5')
    handleCron() {
        this.bot.telegram.sendMessage(process.env.ADMIN_TG_CHATID, '–£—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ 7:45');
    }

    async getStartMessage(telgramId: number) {
        
        let text: string
        let extra: unknown = {}
    
        text = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ë–æ—Ç–∞ SCH24PERM!'
        extra = {
        ...Markup.keyboard([['üìë –û—Ç—á–µ—Ç—ã', '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏']])
            .oneTime()
            .resize(),
        }
        return { text, extra }
      }

    async getCSRFToken() {
        console.log('Getting CSRFToken Async')
        try {
            await this.webClient
                .get('https://epos-rep.permkrai.ru/')
                .then((response) => {
                    let regexp = new RegExp('action=\"(.*)\" ');
                    this.csrf_token = regexp.exec(response.data)[1].replaceAll('&amp;', '&')
                });
            
            await this.webClient.post(this.csrf_token, "username="+process.env.EPOS_LOGIN+"&password=" + process.env.EPOS_PASSWORD)            
        } catch (err) {
            console.log('getCSRFToken: ' + err);
        }
    }

    async makeReport(@Ctx() context: Context){
        console.log('Starting making report')
        try {

            let date = new Date();

            let request = await this.webClient.post('https://epos-rep.permkrai.ru/api/olap/execute',
            {
                "dimensions": {
                    "rows": [
                        {
                            "dimension": "District",
                            "selection": {
                                "values": [
                                    {"caption": "–ü–µ—Ä–º—Å–∫–∏–π –≥–æ—Ä–æ–¥—Å–∫–æ–π –æ–∫—Ä—É–≥","name": "70"}
                                ]
                            }
                        },
                        {
                            "dimension": "OrgranizationType",
                            "selection": {
                                "values": [
                                    {
                                        "caption": "–®–∫–æ–ª–∞",
                                        "name": "1"
                                    }
                                ]
                            }
                        },
                        {
                            "dimension": "School",
                            "selection": {
                                "values": [
                                    {
                                        "caption": "–ú–ê–û–£ ¬´–°–û–® ‚Ññ 24¬ª –≥.–ü–µ—Ä–º–∏",
                                        "name": "1692"
                                    }
                                ]
                            }
                        },
                        {
                            "dimension": "Teacher",
                            "selection": {
                                "values": [
                                    {
                                        "caption": "–ê–∫–∏–º–µ–Ω–∫–æ –ï–ª–µ–Ω–∞ –î–º–∏—Ç—Ä–∏–µ–≤–Ω–∞",
                                        "name": "15589632"
                                    },
                                    {
                                        "caption": "–ê–Ω–¥—Ä–µ–µ–≤–∞ –ù–∞—Ç–∞–ª—å—è –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞",
                                        "name": "15589624"
                                    },
                                    {
                                        "caption": "–ë–∞–∂–µ–Ω–æ–≤–∞ –ï–ª–µ–Ω–∞ –ò–≤–∞–Ω–æ–≤–Ω–∞",
                                        "name": "15589613"
                                    },
                                    {
                                        "caption": "–ë–∞—Ä–∞–Ω–æ–≤–∞ –ú–∞—Ä–∏–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞",
                                        "name": "15589621"
                                    },
                                    {
                                        "caption": "–ë–µ–ª—è–∫–æ–≤–∞ –í–∞–ª–µ—Ä–∏—è –≠–¥—É–∞—Ä–¥–æ–≤–Ω–∞",
                                        "name": "16748317"
                                    },
                                    {
                                        "caption": "–ë–µ—Å–ø–∞–ª–∫–æ –ù–∞—Ç–∞–ª—å—è –ú–∏—Ö–∞–π–ª–æ–≤–Ω–∞",
                                        "name": "15589661"
                                    },
                                    {
                                        "caption": "–ë–∏—Ä—è–ª—å—Ü–µ–≤–∞ –ï–ª–µ–Ω–∞ –ê–Ω–∞—Ç–æ–ª—å–µ–≤–Ω–∞",
                                        "name": "15589612"
                                    },
                                    {
                                        "caption": "–ë–ª–æ—Ö–∏–Ω–∞ –ê–Ω–Ω–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞",
                                        "name": "17241727"
                                    },
                                    {
                                        "caption": "–ë–æ—Ä–∏—Å–æ–≤–∞ –°–≤–µ—Ç–ª–∞–Ω–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞",
                                        "name": "16934511"
                                    },
                                    {
                                        "caption": "–ë–æ—Ä—Ç–Ω–∏–∫–æ–≤–∞ –ù–∞—Ç–∞–ª—å—è –ê–Ω–∞—Ç–æ–ª—å–µ–≤–Ω–∞",
                                        "name": "17241725"
                                    },
                                    {
                                        "caption": "–í–∞—Å–µ–≤–∞ –¢–∞—Ç—å—è–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞",
                                        "name": "15589874"
                                    },
                                    {
                                        "caption": "–í–∞—Å–µ–Ω–∏–Ω–∞ –ù–∞–¥–µ–∂–¥–∞ –°—Ç–µ–ø–∞–Ω–æ–≤–Ω–∞",
                                        "name": "15589973"
                                    },
                                    {
                                        "caption": "–í–∞—Å–∏–ª–∏–Ω—é–∫ –ï–ª–µ–Ω–∞ –ò–≤–∞–Ω–æ–≤–Ω–∞",
                                        "name": "15589627"
                                    },
                                    {
                                        "caption": "–í–µ—Ä–µ—Ç–µ–Ω–Ω–∏–∫–æ–≤–∞ –ê–ª–µ–Ω–∞ –ò–≥–æ—Ä–µ–≤–Ω–∞",
                                        "name": "15589876"
                                    },
                                    {
                                        "caption": "–ì–æ–ª—É–±–æ–≤–∏—á –õ–∏–¥–∏—è –ò–≤–∞–Ω–æ–≤–Ω–∞",
                                        "name": "15589610"
                                    },
                                    {
                                        "caption": "–î–∂—É—Å—É–ø–±–µ–∫–æ–≤–∞ –ñ–∞–Ω–Ω–∞ –†–æ–º–∞–Ω–æ–≤–Ω–∞",
                                        "name": "15589713"
                                    },
                                    {
                                        "caption": "–î—Ä—É–∂–∏–Ω–∏–Ω–∞ –ï–ª–µ–Ω–∞ –ê–Ω–∞—Ç–æ–ª—å–µ–≤–Ω–∞",
                                        "name": "15589631"
                                    },
                                    {
                                        "caption": "–î—É—Ä–Ω–∏—Ü–∏–Ω–∞ –ó–æ—è –ê–Ω—Ç–æ–Ω–æ–≤–Ω–∞",
                                        "name": "15589617"
                                    },
                                    {
                                        "caption": "–î—É—Ä–æ–≤–∞ –°–≤–µ—Ç–ª–∞–Ω–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞",
                                        "name": "16038612"
                                    },
                                    {
                                        "caption": "–ó—É–±–∫–æ–≤–∞ –û–ª—å–≥–∞ –í–∏–∫—Ç–æ—Ä–æ–≤–Ω–∞",
                                        "name": "15589875"
                                    },
                                    {
                                        "caption": "–ò—Å—Ç–æ–º–∏–Ω–∞ –ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –õ–µ–æ–Ω–∏–¥–æ–≤–Ω–∞",
                                        "name": "17241728"
                                    },
                                    {
                                        "caption": "–ö–∞–≥–∞–Ω –¢–∞—Ç—å—è–Ω–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞",
                                        "name": "15589781"
                                    },
                                    {
                                        "caption": "–ö–∞—Ä–ø–æ–≤–∞ –ï–ª–µ–Ω–∞ –ò–ª—å–∏–Ω–∏—á–Ω–∞",
                                        "name": "15589662"
                                    },
                                    {
                                        "caption": "–ö–∏—Å–µ–ª–µ–≤–∞ –ï–ª–µ–Ω–∞ –ù–∏–∫–æ–ª–∞–µ–≤–Ω–∞",
                                        "name": "15589623"
                                    },
                                    {
                                        "caption": "–ö–ª–µ–ø—Ü–∏–Ω–∞ –ï–ª–µ–Ω–∞ –ù–∏–∫–æ–ª–∞–µ–≤–Ω–∞",
                                        "name": "15589685"
                                    },
                                    {
                                        "caption": "–ö–æ–Ω—ã—à–µ–≤ –ú–∏—Ö–∞–∏–ª –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á",
                                        "name": "17307633"
                                    },
                                    {
                                        "caption": "–ö–æ—Ç–µ–ª—å–Ω–∏–∫–æ–≤–∞ –ò—Ä–∏–Ω–∞ –ù–∏–∫–æ–ª–∞–µ–≤–Ω–∞",
                                        "name": "15589622"
                                    },
                                    {
                                        "caption": "–õ–∞–∑—É–∫–æ–≤–∞ –í–µ—Ä–∞ –í–∞—Å–∏–ª—å–µ–≤–Ω–∞",
                                        "name": "15589619"
                                    },
                                    {
                                        "caption": "–õ–µ–∫–æ–º—Ü–µ–≤–∞ –ì–∞–ª–∏–Ω–∞ –ë–æ—Ä–∏—Å–æ–≤–Ω–∞",
                                        "name": "15589782"
                                    },
                                    {
                                        "caption": "–õ–æ–º–∞–µ–≤–∞ –°–≤–µ—Ç–ª–∞–Ω–∞ –ï–≤–≥–µ–Ω—å–µ–≤–Ω–∞",
                                        "name": "15589611"
                                    },
                                    {
                                        "caption": "–õ—É–∫—å—è–Ω—á–µ–Ω–∫–æ –ò—Ä–∏–Ω–∞ –ú–∏—Ö–∞–π–ª–æ–≤–Ω–∞",
                                        "name": "15589628"
                                    },
                                    {
                                        "caption": "–õ—è–¥–æ–≤–∞ –§–∞—Ä–∏–¥–∞ –ê–ø—ã—à–µ–≤–Ω–∞",
                                        "name": "15589803"
                                    },
                                    {
                                        "caption": "–ú–∏–Ω–Ω–∏–≥—É–∑–∏–Ω–∞ –ê–ª—ë–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞",
                                        "name": "15589711"
                                    },
                                    {
                                        "caption": "–ú—É—à–∞–∫–æ–≤–∞ –õ–∞—Ä–∏—Å–∞ –í–∞—Å–∏—Ñ–æ–≤–Ω–∞",
                                        "name": "15589618"
                                    },
                                    {
                                        "caption": "–ù–∞–ø–æ–ª—å—Å–∫–∏—Ö –ï–ª–µ–Ω–∞ –í–∞—Å–∏–ª—å–µ–≤–Ω–∞",
                                        "name": "15589614"
                                    },
                                    {
                                        "caption": "–û–ª–µ–π–Ω–∏–∫ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –ù–∞–∏–ª–æ–≤–Ω–∞",
                                        "name": "15589872"
                                    },
                                    {
                                        "caption": "–ü—å—è–Ω–∫–æ–≤–∞ –ï–ª–µ–Ω–∞ –ò–≤–∞–Ω–æ–≤–Ω–∞",
                                        "name": "15589615"
                                    },
                                    {
                                        "caption": "–†–∞–¥–∏–æ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π –ê–ª–µ–∫—Å–µ–µ–≤–∏—á",
                                        "name": "15964735"
                                    },
                                    {
                                        "caption": "–†–∞–∑–µ–ø–∏–Ω–∞ –û–ª—å–≥–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞",
                                        "name": "15589910"
                                    },
                                    {
                                        "caption": "–†—ã—á–∞–≥–æ–≤–∞ –ï–ª–µ–Ω–∞ –ë–æ—Ä–∏—Å–æ–≤–Ω–∞",
                                        "name": "16723154"
                                    },
                                    {
                                        "caption": "–†—è–∑–∞–Ω–æ–≤–∞ –ò—Ä–∏–Ω–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞",
                                        "name": "17272350"
                                    },
                                    {
                                        "caption": "–°–∞—Ä–∞–ø—É–ª–æ–≤–∞ –¢–∞–º–∞—Ä–∞ –ì–µ–Ω–Ω–∞–¥—å–µ–≤–Ω–∞",
                                        "name": "16050780"
                                    },
                                    {
                                        "caption": "–°–∞—Ä–∞–ø—É–ª–æ–≤–∞ –¢–∞–º–∞—Ä–∞ –ì–µ–Ω–Ω–∞–¥—å–µ–≤–Ω–∞",
                                        "name": "15964532"
                                    },
                                    {
                                        "caption": "–°–æ–ª–æ–º–∞—Ç–æ–≤–∞ –ó–∏–Ω–∞–∏–¥–∞ –ë–æ—Ä–∏—Å–æ–≤–Ω–∞",
                                        "name": "15589620"
                                    },
                                    {
                                        "caption": "–°—É—Ö–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞",
                                        "name": "15992370"
                                    },
                                    {
                                        "caption": "–¢–∫–∞—á–µ–Ω–∫–æ –ò—Ä–∏–Ω–∞ –ù–∏–∫–æ–ª–∞–µ–≤–Ω–∞",
                                        "name": "16350445"
                                    },
                                    {
                                        "caption": "–§–µ–¥–æ—Å–µ–µ–≤ –î–∞–Ω–∏–ª –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á",
                                        "name": "17178608"
                                    },
                                    {
                                        "caption": "–ß–µ–ª—É—Ö–∏–¥–∏ –¢–∞—Ç—å—è–Ω–∞ –ù–∏–∫–æ–ª–∞–µ–≤–Ω–∞",
                                        "name": "15589630"
                                    },
                                    {
                                        "caption": "–ß–µ—Ä–∞–Ω–µ–≤–∞ –ù–∞—Ç–∞–ª—å—è –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–Ω–∞",
                                        "name": "15589616"
                                    },
                                    {
                                        "caption": "–®–∞–≤—à—É–∫–æ–≤–∞ –õ–∏–ª–∏—è –ó–∞–≥–∏—Ä–æ–≤–Ω–∞",
                                        "name": "15589629"
                                    },
                                    {
                                        "caption": "–®–∏–ª–æ–≤–∞ –ï–ª–µ–Ω–∞ –ü–∞–≤–ª–æ–≤–Ω–∞",
                                        "name": "15589625"
                                    },
                                    {
                                        "caption": "–®–∏–ª–æ–≤–∞ –ö—Å–µ–Ω–∏—è –ê–ª–µ–∫—Å–µ–µ–≤–Ω–∞",
                                        "name": "16723153"
                                    },
                                    {
                                        "caption": "–®—É–±–∏–Ω–∞ –í–µ—Ä–∞ –ê–ª–µ–∫—Å–µ–µ–≤–Ω–∞",
                                        "name": "15589943"
                                    }
                                ]
                            }
                        },
                        {"dimension": "FromDate", "selection": {"values": [{"name": "2023-09-01"}]}},
                        {"dimension": "ToDate", "selection": {"values": [{"name": date.toISOString()}]}}
                    ]
                },
                "name": "REP_MON_QA_TEACHER"
            }
            );

            
            let data = request.data;
            let test = [];

            data.cells.forEach((cell, index) => {
                if(cell[20].value == "100,00") return
                test[index]=[cell[4].value, cell[20].value]
            });
            test = test.slice(1, -1).sort();
            
            let msg = `‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –≤–µ–¥–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ –Ω–∞ ${date.toLocaleDateString()}\n`;
            test.forEach((element) => msg += element[0] + " - " + element[1]+ "%\n")
            
            context.sendMessage(msg)

        } catch (err) {
            console.error(err)
        }
    }
}